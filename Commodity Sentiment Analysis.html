<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Commodity Prediction System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .api-config {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .config-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
        }
        
        .config-section h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .commodity-selector {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .commodity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .commodity-btn {
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .commodity-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .commodity-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border-color: white;
        }
        
        .commodity-icon {
            font-size: 1.5rem;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-item label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ff8c00);
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #e9ecef;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        
        .status-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .status-value {
            color: #667eea;
            font-family: monospace;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .prediction-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .prediction-price {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .prediction-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            opacity: 0.9;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .detail-label {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #667eea;
        }
        
        .result-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            position: relative;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .trade-signal {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        
        .signal-buy {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .signal-sell {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }
        
        .signal-hold {
            background: linear-gradient(135deg, #6c757d, #adb5bd);
            color: white;
        }
        
        .methodology {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-top: 20px;
        }
        
        .methodology h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .methodology p {
            line-height: 1.6;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Ultimate Commodity Prediction System</h1>
            <p>AI-Powered Price Forecasting with Real-Time Data Integration</p>
        </div>
        
        <div class="main-content">
            <!-- API Configuration Section -->
            <div class="api-config">
                <h2>üîë API Configuration</h2>
                <p>Configure your API credentials for real-time data fetching</p>
                
                <div class="config-grid">
                    <div class="config-section">
                        <h4>Reddit API Configuration</h4>
                        <input type="text" id="redditClientId" class="config-input" placeholder="Reddit Client ID">
                        <input type="password" id="redditClientSecret" class="config-input" placeholder="Reddit Client Secret">
                        <input type="text" id="redditUserAgent" class="config-input" placeholder="User Agent (e.g., CommodityTrader/1.0)" value="CommodityTrader/1.0">
                    </div>
                    
                    <div class="config-section">
                        <h4>Analysis Settings</h4>
                        <select id="dataSource" class="config-input">
                            <option value="live">Live Data (API Required)</option>
                            <option value="demo" selected>Demo Mode (Sample Data)</option>
                        </select>
                        <input type="number" id="redditPostLimit" class="config-input" placeholder="Reddit Posts Limit" value="100" min="50" max="500">
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn-success" onclick="testApiConnection()">üîç Test API Connection</button>
                    <button class="btn-secondary" onclick="toggleApiConfig()">Hide Configuration</button>
                </div>
                
                <div id="apiStatus" class="status-display hidden">
                    <div class="status-item">
                        <span class="status-label">Reddit API Status:</span>
                        <span class="status-value" id="redditStatus">Not Connected</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Yahoo Finance Status:</span>
                        <span class="status-value" id="yahooStatus">Ready</span>
                    </div>
                </div>
            </div>

            <!-- Commodity Selection -->
            <div class="commodity-selector">
                <h2>Select Commodity for Analysis</h2>
                <div class="commodity-grid">
                    <div class="commodity-btn active" data-commodity="oil">
                        <div class="commodity-icon">üõ¢Ô∏è</div>
                        <div>Crude Oil</div>
                    </div>
                    <div class="commodity-btn" data-commodity="brent_oil">
                        <div class="commodity-icon">‚ö´</div>
                        <div>Brent Oil</div>
                    </div>
                    <div class="commodity-btn" data-commodity="natural_gas">
                        <div class="commodity-icon">üî•</div>
                        <div>Natural Gas</div>
                    </div>
                    <div class="commodity-btn" data-commodity="gold">
                        <div class="commodity-icon">ü•á</div>
                        <div>Gold</div>
                    </div>
                    <div class="commodity-btn" data-commodity="silver">
                        <div class="commodity-icon">ü•à</div>
                        <div>Silver</div>
                    </div>
                    <div class="commodity-btn" data-commodity="copper">
                        <div class="commodity-icon">üîó</div>
                        <div>Copper</div>
                    </div>
                    <div class="commodity-btn" data-commodity="aluminum">
                        <div class="commodity-icon">‚ö°</div>
                        <div>Aluminum</div>
                    </div>
                    <div class="commodity-btn" data-commodity="wheat">
                        <div class="commodity-icon">üåæ</div>
                        <div>Wheat</div>
                    </div>
                    <div class="commodity-btn" data-commodity="corn">
                        <div class="commodity-icon">üåΩ</div>
                        <div>Corn</div>
                    </div>
                    <div class="commodity-btn" data-commodity="soybeans">
                        <div class="commodity-icon">ü´ò</div>
                        <div>Soybeans</div>
                    </div>
                    <div class="commodity-btn" data-commodity="coffee">
                        <div class="commodity-icon">‚òï</div>
                        <div>Coffee</div>
                    </div>
                    <div class="commodity-btn" data-commodity="sugar">
                        <div class="commodity-icon">üçØ</div>
                        <div>Sugar</div>
                    </div>
                    <div class="commodity-btn" data-commodity="cotton">
                        <div class="commodity-icon">üå±</div>
                        <div>Cotton</div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Controls -->
            <div class="section">
                <h3>‚öôÔ∏è Analysis Configuration</h3>
                
                <div class="control-grid">
                    <div class="control-item">
                        <label>Forecast Period (Days):</label>
                        <input type="number" id="forecastDays" value="7" min="1" max="30">
                    </div>
                    
                    <div class="control-item">
                        <label>Sentiment Weight:</label>
                        <input type="range" id="sentimentWeight" min="0" max="1" step="0.1" value="0.4">
                        <span id="weightDisplay">40%</span>
                    </div>
                    
                    <div class="control-item">
                        <label>Market Volatility:</label>
                        <select id="volatilityLevel">
                            <option value="low">Low Volatility</option>
                            <option value="medium" selected>Medium Volatility</option>
                            <option value="high">High Volatility</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label>ARIMA Model:</label>
                        <select id="arimaModel">
                            <option value="auto" selected>Auto-Select (2,1,1)</option>
                            <option value="simple">Simple (1,1,1)</option>
                            <option value="complex">Complex (3,1,2)</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label>Historical Data Period:</label>
                        <select id="dataPeriod">
                            <option value="1mo">1 Month</option>
                            <option value="3mo" selected>3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y">1 Year</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label>Confidence Threshold:</label>
                        <input type="range" id="confidenceThreshold" min="0.5" max="0.95" step="0.05" value="0.75">
                        <span id="confidenceDisplay">75%</span>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn-success" onclick="runCompleteAnalysis()">üöÄ Run Complete Analysis</button>
                    <button class="btn-primary" onclick="fetchRealTimeData()">üì° Fetch Real-Time Data</button>
                    <button class="btn-primary" onclick="runForecastOnly()">üìà Forecast Only</button>
                    <button class="btn-warning" onclick="runSentimentOnly()">üí≠ Sentiment Only</button>
                    <button class="btn-secondary" onclick="clearAllResults()">üóëÔ∏è Clear Results</button>
                </div>
            </div>
            
            <!-- Loading Display -->
            <div id="loadingDisplay" class="loading hidden">
                <div class="spinner"></div>
                <div id="loadingText">Initializing analysis...</div>
            </div>
            
            <!-- Results Section -->
            <div id="results" class="hidden">
                <!-- Final Prediction Card -->
                <div id="predictionCard" class="prediction-card">
                    <h2>Final Prediction for <span id="resultsCommodity">Oil</span></h2>
                    <div class="prediction-price">
                        <span id="currencySymbol">$</span><span id="finalPrice">--</span>
                        <span class="unit-display" id="resultsUnit">/barrel</span>
                    </div>
                    <div class="prediction-details">
                        <div class="detail-item">
                            <div class="detail-value"><span id="currencySymbol2">$</span><span id="arimaPrice">--</span></div>
                            <div class="detail-label">ARIMA Forecast</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value"><span id="sentimentScore">--</span></div>
                            <div class="detail-label">Hybrid Sentiment</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value"><span id="confidence">--</span>%</div>
                            <div class="detail-label">Confidence</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value"><span id="priceChange">--</span>%</div>
                            <div class="detail-label">Expected Change</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value"><span id="currentPrice">--</span></div>
                            <div class="detail-label">Current Price</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value"><span id="dataPoints">--</span></div>
                            <div class="detail-label">Data Points Used</div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Signal -->
                <div id="tradeSignal" class="trade-signal signal-hold">
                    <div>Trading Recommendation: <span id="signalText">ANALYZING...</span></div>
                    <div style="font-size: 0.9rem; margin-top: 10px;" id="signalReason">Analysis in progress...</div>
                </div>
                
                <!-- Results Grid -->
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-title">üìà ARIMA Analysis</div>
                        <div id="arimaResults">
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="color: #6c757d;">Waiting for analysis...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-title">üí≠ Sentiment Analysis</div>
                        <div id="sentimentResults">
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="color: #6c757d;">Waiting for analysis...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-title">üìä Market Data</div>
                        <div id="marketData">
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="color: #6c757d;">Waiting for data...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-title">üîç Data Sources</div>
                        <div id="dataSources">
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="color: #6c757d;">Waiting for sources...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Chart -->
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
                
                <!-- Enhanced Methodology -->
                <div class="methodology">
                    <h4>üß† Enhanced AI Methodology</h4>
                    <p><strong>1. Real-Time Data Integration:</strong> Fetches live price data from Yahoo Finance and sentiment data from Reddit using specialized APIs.</p>
                    <p><strong>2. ARIMA Forecasting:</strong> Advanced time series analysis with auto-regressive integrated moving average modeling, adaptable parameters (p,d,q).</p>
                    <p><strong>3. Hybrid Sentiment Analysis:</strong> Combines domain-specific lexicon (60%) with contextual grammar analysis (40%) including negation detection and intensifier recognition.</p>
                    <p><strong>4. Multi-Source Sentiment:</strong> Aggregates sentiment from commodity-specific subreddits and search terms, with duplicate removal and relevance filtering.</p>
                    <p><strong>5. Volatility-Adjusted Predictions:</strong> Incorporates market volatility levels to adjust prediction confidence and sentiment weighting.</p>
                    <p><strong>6. Trading Signal Generation:</strong> Uses multi-factor analysis combining price trends, sentiment scores, and market conditions to generate BUY/SELL/HOLD recommendations.</p>
                    <p><strong>Final Formula:</strong> Final Price = ARIMA Price √ó (1 + Hybrid Sentiment Score √ó Weight √ó Volatility Factor √ó Confidence Multiplier)</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Comprehensive commodity configurations with enhanced data
        const commodities = {
            oil: {
                name: "Crude Oil (WTI)",
                description: "West Texas Intermediate crude oil futures",
                unit: "$/barrel",
                exchange: "NYMEX",
                yahoo_symbol: "CL=F",
                icon: "üõ¢Ô∏è",
                currency: "$",
                factors: "OPEC decisions, geopolitical tensions, refinery capacity, seasonal demand, inventory levels, economic growth",
                reddit_terms: ['oil', 'crude oil', 'WTI', 'Brent', 'OPEC', 'petroleum'],
                subreddits: ['energy', 'investing', 'SecurityAnalysis', 'stocks', 'worldnews'],
                samplePrices: [68.25, 69.80, 67.95, 70.45, 72.10, 69.85, 71.30, 73.75, 71.20, 74.65, 76.40, 73.85, 75.20, 77.95, 75.60, 76.85, 79.30, 77.75, 80.20, 78.95, 81.40, 80.15, 82.85, 81.60, 84.20, 82.95, 85.60, 84.35, 87.10, 85.75, 88.40, 87.25, 89.80, 88.55, 91.20, 89.95, 92.60, 91.35, 94.10, 92.85, 95.40, 94.15, 96.80, 95.55, 98.20, 96.95, 99.60, 98.35, 101.10, 99.85, 102.40, 101.15, 103.80, 102.55, 105.20, 103.95, 106.60, 105.35, 108.10, 106.85],
                sampleSentiment: [
                    "Oil prices surge to highest level in three months amid supply concerns",
                    "OPEC announces unexpected production cuts effective immediately", 
                    "Crude futures rally on geopolitical tensions in Middle East",
                    "Energy demand showing signs of recovery following economic reopening",
                    "WTI crude breaks above $80 resistance level with strong momentum",
                    "Oil inventory drawdowns exceed expectations supporting price rally",
                    "Geopolitical risks in major oil producing regions escalate tensions"
                ],
                sentimentTerms: {
                    'opec': 0, 'crude': 0, 'barrel': 0, 'refinery': 0, 'drilling': 0, 'pipeline': 0,
                    'surge': 0.8, 'rally': 0.8, 'bullish': 0.9, 'shortage': 0.7, 'tight': 0.6,
                    'plunge': -0.9, 'crash': -1.0, 'oversupply': -0.7, 'glut': -0.8, 'bearish': -0.9
                }
            },
            brent_oil: {
                name: "Brent Oil",
                description: "Brent crude oil futures",
                unit: "$/barrel",
                exchange: "ICE",
                yahoo_symbol: "BZ=F",
                icon: "‚ö´",
                currency: "$",
                factors: "North Sea production, European demand, global oil trade, geopolitical factors",
                reddit_terms: ['Brent oil', 'Brent crude', 'ICE Brent', 'North Sea oil'],
                subreddits: ['energy', 'investing', 'SecurityAnalysis', 'stocks'],
                samplePrices: [72.20, 73.85, 71.50, 74.90, 76.45, 74.10, 75.75, 78.30, 76.95, 79.60, 81.25, 78.90, 80.55, 83.10, 81.75, 82.40, 85.95, 84.60, 87.25, 85.90, 88.55, 87.20, 89.85, 88.50, 91.15, 89.80, 92.45, 91.10, 93.75, 92.40, 95.05, 93.70, 96.35, 95.00, 97.65, 96.30, 98.95, 97.60, 100.25, 98.90, 101.55, 100.20, 102.85, 101.50, 104.15, 102.80, 105.45, 104.10, 106.75, 105.40, 108.05, 106.70, 109.35, 108.00, 110.65, 109.30, 111.95, 110.60, 113.25, 111.90],
                sampleSentiment: [
                    "Brent crude reaches new monthly highs on supply disruptions",
                    "North Sea production cuts support Brent oil premium",
                    "European energy security concerns boost Brent demand",
                    "Brent-WTI spread widens on Atlantic basin tightness"
                ],
                sentimentTerms: {
                    'brent': 0, 'north sea': 0, 'ice': 0, 'atlantic': 0,
                    'premium': 0.6, 'spread': 0, 'disruption': 0.7, 'security': 0.5
                }
            },
            natural_gas: {
                name: "Natural Gas",
                description: "Henry Hub Natural Gas futures",
                unit: "$/MMBtu",
                exchange: "NYMEX", 
                yahoo_symbol: "NG=F",
                icon: "üî•",
                currency: "$",
                factors: "Weather patterns, storage levels, LNG exports, renewable energy, heating/cooling demand",
                reddit_terms: ['natural gas', 'gas prices', 'Henry Hub', 'LNG', 'gas storage'],
                subreddits: ['energy', 'investing', 'NaturalGas', 'stocks'],
                samplePrices: [2.85, 2.92, 2.78, 3.05, 3.15, 2.95, 3.08, 3.25, 3.12, 3.35, 3.28, 3.02, 3.18, 3.42, 3.20, 3.38, 3.55, 3.45, 3.68, 3.52, 3.70, 3.58, 3.85, 3.72, 3.90],
                sampleSentiment: [
                    "Natural gas prices spike on cold weather forecast",
                    "LNG export capacity constraints support domestic prices",
                    "Gas storage levels below seasonal averages",
                    "Winter heating demand surge drives gas futures higher"
                ],
                sentimentTerms: {
                    'gas': 0, 'lng': 0.4, 'storage': 0, 'weather': 0.3, 'heating': 0.5, 'cooling': 0.4,
                    'cold': 0.8, 'hot': 0.6, 'injection': -0.4, 'withdrawal': 0.6,
                    'warm': -0.5, 'mild': -0.4, 'oversupply': -0.8, 'glut': -0.7
                }
            },
            gold: {
                name: "Gold (COMEX)",
                description: "Gold futures contracts",
                unit: "$/oz",
                exchange: "COMEX",
                yahoo_symbol: "GC=F",
                icon: "ü•á",
                currency: "$",
                factors: "USD strength, inflation expectations, central bank policies, safe-haven demand, jewelry demand, mining supply",
                reddit_terms: ['gold', 'gold price', 'bullion', 'precious metals', 'GLD'],
                subreddits: ['Gold', 'investing', 'SecurityAnalysis', 'stocks', 'precious_metals'],
                samplePrices: [1950, 1965, 1943, 1972, 1988, 1956, 1974, 1999, 1985, 2010, 2025, 1998, 2015, 2040, 1995, 2020, 2055, 2033, 2070, 2048, 2085, 2062, 2090, 2075, 2110],
                sampleSentiment: [
                    "Gold reaches new highs as inflation concerns mount globally",
                    "Federal Reserve signals dovish stance supporting precious metals",
                    "Safe-haven demand drives bullion higher amid uncertainty",
                    "Central banks continue accumulating gold reserves as hedge"
                ],
                sentimentTerms: {
                    'gold': 0, 'bullion': 0, 'ounce': 0, 'fed': 0, 'inflation': 0.5, 'hedge': 0.4,
                    'haven': 0.7, 'store': 0.5, 'precious': 0.4, 'jewelry': 0.3, 'mining': 0,
                    'selloff': -0.7, 'hawkish': -0.6, 'tightening': -0.5, 'strong dollar': -0.8
                }
            },
            silver: {
                name: "Silver (COMEX)",
                description: "Silver futures contracts", 
                unit: "$/oz",
                exchange: "COMEX",
                yahoo_symbol: "SI=F",
                icon: "ü•à",
                currency: "$",
                factors: "Industrial demand, solar panel production, USD strength, gold correlation, supply disruptions",
                reddit_terms: ['silver', 'silver price', 'precious metals', 'SLV', 'industrial silver'],
                subreddits: ['Silverbugs', 'investing', 'SecurityAnalysis', 'stocks', 'precious_metals'],
                samplePrices: [23.50, 24.10, 22.95, 24.75, 25.20, 23.80, 24.45, 25.60, 24.90, 26.15, 25.75, 24.30, 25.85, 26.50, 25.10, 26.20, 27.10, 26.80, 27.45, 26.95, 28.20, 27.80, 28.60, 28.15, 29.40],
                sampleSentiment: [
                    "Silver industrial demand surges on solar panel boom",
                    "Electric vehicle revolution drives metal consumption",
                    "Silver mining strikes create supply constraints",
                    "Precious metals investment demand reaches decade highs"
                ],
                sentimentTerms: {
                    'silver': 0, 'industrial': 0.4, 'solar': 0.6, 'electronics': 0.3, 'mining': 0,
                    'shortage': 0.8, 'deficit': 0.7, 'demand': 0.5, 'supply': 0,
                    'surplus': -0.6, 'oversupply': -0.7, 'substitution': -0.5
                }
            },
            copper: {
                name: "Copper (COMEX)",
                description: "High Grade Copper futures",
                unit: "$/lb",
                exchange: "COMEX",
                yahoo_symbol: "HG=F",
                icon: "üîó",
                currency: "$",
                factors: "Construction activity, China demand, electric vehicle production, infrastructure spending, mining strikes",
                reddit_terms: ['copper', 'copper price', 'industrial metals', 'construction metals'],
                subreddits: ['investing', 'SecurityAnalysis', 'stocks', 'materials'],
                samplePrices: [3.85, 3.92, 3.74, 3.98, 4.05, 3.89, 3.96, 4.12, 4.07, 4.18, 4.25, 4.03, 4.15, 4.31, 4.09, 4.22, 4.38, 4.29, 4.45, 4.33, 4.50, 4.42, 4.65, 4.58, 4.72],
                sampleSentiment: [
                    "Copper demand surge on infrastructure spending boom",
                    "China construction recovery drives metal higher",
                    "Electric vehicle copper requirements exceed forecasts",
                    "Mining strikes threaten global copper supply chains"
                ],
                sentimentTerms: {
                    'copper': 0, 'construction': 0.5, 'infrastructure': 0.6, 'china': 0.4, 'ev': 0.7,
                    'shortage': 0.8, 'strike': 0.6, 'demand': 0.5, 'scrap': -0.3,
                    'surplus': -0.6, 'slowdown': -0.7, 'recession': -0.9
                }
            },
            aluminum: {
                name: "Aluminum (LME)",
                description: "London Metal Exchange Aluminum futures",
                unit: "$/MT",
                exchange: "LME",
                yahoo_symbol: "ALU24.LME", // Try LME symbol first
                backup_symbols: ["ALI=F", "ALU=F", "ALUMINUM"], // Backup options
                icon: "‚ö°",
                currency: "$",
                factors: "Energy costs, automotive demand, packaging industry, China production, bauxite supply",
                reddit_terms: ['aluminum', 'aluminium', 'bauxite', 'industrial metals'],
                subreddits: ['investing', 'SecurityAnalysis', 'stocks', 'materials'],
                samplePrices: [2350, 2380, 2325, 2395, 2420, 2365, 2385, 2440, 2405, 2460, 2485, 2430, 2450, 2495, 2435, 2470, 2515, 2490, 2535, 2510, 2550, 2525, 2575, 2560, 2590, 2575, 2595, 2580, 2610, 2595, 2620, 2605, 2635, 2620, 2650, 2635, 2665, 2650, 2680, 2665, 2690, 2675, 2705, 2690, 2720, 2705, 2735, 2720, 2750, 2735, 2770, 2755, 2785, 2770, 2800, 2785, 2815, 2800, 2830, 2489.60], // Updated with current price
                sampleSentiment: [
                    "Aluminum demand strong from automotive lightweighting trend",
                    "Energy crisis impacts aluminum smelting capacity globally", 
                    "Packaging industry drives steady aluminum consumption",
                    "China production cuts support global aluminum prices",
                    "LME aluminum breaks above key resistance levels",
                    "Industrial metals rally on infrastructure spending hopes"
                ],
                sentimentTerms: {
                    'aluminum': 0, 'automotive': 0.5, 'packaging': 0.3, 'energy': -0.4, 'smelter': 0,
                    'shortage': 0.8, 'capacity': 0.4, 'lightweight': 0.5, 'lme': 0,
                    'oversupply': -0.7, 'sanctions': 0.6, 'tariff': -0.5
                }
            },
            wheat: {
                name: "Wheat (CBOT)",
                description: "Chicago Board of Trade Wheat futures",
                unit: "$/bushel",
                exchange: "CBOT",
                yahoo_symbol: "ZW=F",
                icon: "üåæ",
                currency: "$",
                factors: "Weather conditions, crop yields, export demand, Russia/Ukraine production, global food security",
                reddit_terms: ['wheat', 'wheat price', 'grain', 'agriculture', 'crop yields'],
                subreddits: ['agriculture', 'investing', 'SecurityAnalysis', 'farming'],
                samplePrices: [5.85, 5.92, 5.78, 6.05, 6.15, 5.95, 6.08, 6.25, 6.12, 6.35, 6.28, 6.02, 6.18, 6.42, 6.20, 6.38, 6.55, 6.45, 6.68, 6.52, 6.75, 6.60, 6.82, 6.70, 6.95],
                sampleSentiment: [
                    "Wheat prices rally on drought concerns in major regions",
                    "Export restrictions from key producers tighten supply",
                    "Global food security fears drive strategic purchasing",
                    "Weather patterns suggest challenging growing conditions"
                ],
                sentimentTerms: {
                    'wheat': 0, 'crop': 0, 'harvest': 0, 'drought': 0.8, 'flood': 0.7, 'yield': 0,
                    'shortage': 0.9, 'export': 0.5, 'food': 0.4, 'ukraine': 0.6,
                    'surplus': -0.7, 'bumper': -0.8, 'oversupply': -0.6, 'abundant': -0.5
                }
            },
            corn: {
                name: "Corn (CBOT)",
                description: "Chicago Board of Trade Corn futures",
                unit: "$/bushel",
                exchange: "CBOT",
                yahoo_symbol: "ZC=F",
                icon: "üåΩ",
                currency: "$",
                factors: "Ethanol demand, livestock feed, weather patterns, Brazil/Argentina crops, biofuel policies",
                reddit_terms: ['corn', 'ethanol', 'feed corn', 'maize', 'biofuel'],
                subreddits: ['agriculture', 'investing', 'SecurityAnalysis', 'farming'],
                samplePrices: [4.25, 4.32, 4.18, 4.35, 4.45, 4.28, 4.38, 4.52, 4.42, 4.58, 4.65, 4.35, 4.48, 4.68, 4.40, 4.55, 4.72, 4.62, 4.78, 4.68, 4.85, 4.75, 4.92, 4.80, 5.05],
                sampleSentiment: [
                    "Corn ethanol demand strengthens on renewable fuel mandates",
                    "Livestock feed demand supports corn price floor",
                    "South American crop concerns boost US corn exports",
                    "Biofuel policy changes create new demand dynamics"
                ],
                sentimentTerms: {
                    'corn': 0, 'ethanol': 0.5, 'feed': 0.3, 'livestock': 0.4, 'drought': 0.8,
                    'planting': 0.3, 'harvest': 0, 'biofuel': 0.6, 'demand': 0.5,
                    'surplus': -0.6, 'record': -0.5, 'abundant': -0.6
                }
            },
            soybeans: {
                name: "Soybeans (CBOT)",
                description: "Chicago Board of Trade Soybean futures",
                unit: "$/bushel",
                exchange: "CBOT",
                yahoo_symbol: "ZS=F",
                icon: "ü´ò",
                currency: "$",
                factors: "China imports, crushing demand, weather conditions, Brazil production, trade relations",
                reddit_terms: ['soybeans', 'soy', 'soybean meal', 'soybean oil', 'China trade'],
                subreddits: ['agriculture', 'investing', 'SecurityAnalysis', 'farming'],
                samplePrices: [12.85, 12.95, 12.68, 13.15, 13.35, 12.95, 13.18, 13.45, 13.25, 13.58, 13.48, 13.12, 13.32, 13.65, 13.28, 13.52, 13.78, 13.68, 13.88, 13.75, 14.05, 13.90, 14.20, 14.08, 14.35],
                sampleSentiment: [
                    "China soybean imports surge on trade normalization",
                    "Crushing demand for soybean meal and oil remains strong",
                    "Brazilian soybean crop faces weather challenges",
                    "Trade relations improvement boosts export prospects"
                ],
                sentimentTerms: {
                    'soybean': 0, 'china': 0.6, 'crushing': 0.4, 'meal': 0.3, 'oil': 0.3,
                    'import': 0.5, 'export': 0.5, 'trade': 0, 'drought': 0.8,
                    'tariff': -0.7, 'trade war': -0.8, 'surplus': -0.6
                }
            },
            coffee: {
                name: "Coffee (ICE)",
                description: "Intercontinental Exchange Coffee C futures",
                unit: "$/lb",
                exchange: "ICE",
                yahoo_symbol: "KC=F",
                icon: "‚òï",
                currency: "$",
                factors: "Brazil weather, frost risk, global consumption, currency fluctuations, arabica vs robusta",
                reddit_terms: ['coffee', 'coffee price', 'arabica', 'robusta', 'Brazil coffee'],
                subreddits: ['Coffee', 'investing', 'SecurityAnalysis', 'agriculture'],
                samplePrices: [1.45, 1.52, 1.38, 1.58, 1.65, 1.48, 1.55, 1.72, 1.62, 1.78, 1.85, 1.55, 1.68, 1.82, 1.58, 1.75, 1.88, 1.80, 1.95, 1.85, 2.02, 1.92, 2.08, 1.98, 2.15],
                sampleSentiment: [
                    "Coffee prices surge on Brazil frost concerns",
                    "Global coffee consumption recovery post-pandemic",
                    "Arabica premium widens on quality supply tightness",
                    "Weather risks in key growing regions escalate"
                ],
                sentimentTerms: {
                    'coffee': 0, 'brazil': 0.4, 'frost': 0.9, 'arabica': 0, 'robusta': 0,
                    'consumption': 0.4, 'harvest': 0, 'weather': 0.3, 'drought': 0.8,
                    'surplus': -0.6, 'inventory': -0.4, 'oversupply': -0.7
                }
            },
            sugar: {
                name: "Sugar #11 (ICE)",
                description: "Intercontinental Exchange Sugar #11 futures",
                unit: "cents/lb",
                exchange: "ICE",
                yahoo_symbol: "SB=F",
                icon: "üçØ",
                currency: "¬¢",
                factors: "Brazil ethanol mix, India monsoon, global consumption, oil prices, currency effects",
                reddit_terms: ['sugar', 'sugar price', 'sugar #11', 'Brazil sugar', 'ethanol'],
                subreddits: ['investing', 'SecurityAnalysis', 'agriculture'],
                samplePrices: [18.5, 19.2, 17.8, 19.8, 20.5, 18.9, 19.5, 21.2, 20.1, 21.8, 22.5, 19.8, 20.8, 22.2, 19.5, 21.5, 23.1, 22.0, 23.8, 22.5, 24.2, 23.5, 24.8, 24.0, 25.5],
                sampleSentiment: [
                    "Sugar prices rally on India monsoon concerns",
                    "Brazil mills favor ethanol over sugar production",
                    "Global sugar consumption shows steady recovery",
                    "Oil price strength supports ethanol-sugar dynamics"
                ],
                sentimentTerms: {
                    'sugar': 0, 'brazil': 0.4, 'ethanol': -0.3, 'india': 0.4, 'monsoon': 0.6,
                    'mill': 0, 'crushing': 0, 'consumption': 0.4, 'deficit': 0.8,
                    'surplus': -0.7, 'stocks': -0.4, 'carry': -0.3
                }
            },
            cotton: {
                name: "Cotton #2 (ICE)",
                description: "Intercontinental Exchange Cotton #2 futures",
                unit: "cents/lb",
                exchange: "ICE",
                yahoo_symbol: "CT=F",
                icon: "üå±",
                currency: "¬¢",
                factors: "China demand, US planting, weather conditions, textile industry, synthetic fiber competition",
                reddit_terms: ['cotton', 'cotton price', 'textile', 'fiber', 'cotton futures'],
                subreddits: ['investing', 'SecurityAnalysis', 'agriculture', 'fashion'],
                samplePrices: [68.5, 70.2, 66.8, 71.8, 73.5, 69.2, 71.5, 75.2, 72.8, 76.5, 78.2, 71.8, 74.2, 77.8, 72.5, 75.8, 79.5, 77.2, 81.2, 78.8, 82.5, 80.2, 84.8, 82.5, 86.2],
                sampleSentiment: [
                    "Cotton demand recovery in textile manufacturing",
                    "China cotton imports increase on trade normalization",
                    "US cotton planting intentions show acreage growth",
                    "Synthetic fiber competition pressures natural cotton"
                ],
                sentimentTerms: {
                    'cotton': 0, 'textile': 0.4, 'china': 0.5, 'planting': 0.3, 'acreage': 0,
                    'demand': 0.5, 'mill': 0.3, 'synthetic': -0.5, 'polyester': -0.4,
                    'surplus': -0.6, 'carryover': -0.4, 'stocks': -0.3
                }
            }
        };

        // Global sentiment terms (applicable to all commodities)
        const globalSentimentTerms = {
            // Positive
            'surge': 0.8, 'rise': 0.6, 'increase': 0.5, 'gain': 0.7, 'boost': 0.8,
            'strong': 0.6, 'bullish': 0.9, 'optimistic': 0.8, 'recovery': 0.7,
            'growth': 0.6, 'profit': 0.7, 'positive': 0.6, 'up': 0.4, 'higher': 0.5,
            'rally': 0.8, 'rebound': 0.7, 'momentum': 0.5, 'breakthrough': 0.8,
            'strength': 0.6, 'outperform': 0.7, 'upbeat': 0.6, 'robust': 0.7,
            
            // Negative
            'fall': -0.6, 'drop': -0.7, 'decline': -0.6, 'plunge': -0.9, 'crash': -1.0,
            'weak': -0.6, 'bearish': -0.9, 'pessimistic': -0.8, 'crisis': -0.9,
            'collapse': -1.0, 'loss': -0.7, 'negative': -0.6, 'down': -0.4, 'lower': -0.5,
            'concern': -0.5, 'worry': -0.6, 'fear': -0.7, 'uncertainty': -0.6,
            'volatility': -0.4, 'instability': -0.6, 'recession': -0.9, 'risk': -0.5,
            'threat': -0.7, 'challenge': -0.4, 'struggle': -0.6, 'pressure': -0.5,
            'slump': -0.8, 'tumble': -0.8, 'deteriorate': -0.7, 'weaken': -0.6,
            
            // Market terms (neutral)
            'price': 0, 'market': 0, 'trading': 0, 'futures': 0, 'commodity': 0,
            'supply': 0, 'demand': 0, 'production': 0, 'inventory': 0, 'stock': 0,
            'analysis': 0, 'forecast': 0, 'outlook': 0, 'report': 0, 'data': 0
        };

        // Enhanced real-time price fetching with multiple symbol attempts
        async function fetchCurrentPrice(commodity) {
            const config = commodities[commodity];
            
            // Try multiple symbols for better accuracy
            const symbolsToTry = [config.yahoo_symbol];
            if (config.backup_symbols) {
                symbolsToTry.push(...config.backup_symbols);
            }
            
            let lastError = null;
            
            for (const symbol of symbolsToTry) {
                try {
                    showLoading(`Fetching ${config.name} price (trying ${symbol})...`);
                    
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=3mo`;
                    
                    console.log(`Attempting to fetch from: ${yahooUrl}`);
                    
                    const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status} for symbol ${symbol}`);
                    }
                    
                    const data = await response.json();
                    console.log(`Response for ${symbol}:`, data);
                    
                    if (data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        const timestamps = result.timestamp;
                        const prices = result.indicators.quote[0];
                        
                        // Validate we have actual data
                        if (!meta.regularMarketPrice && !meta.previousClose) {
                            throw new Error(`No price data available for ${symbol}`);
                        }
                        
                        console.log(`‚úÖ Successfully fetched data for ${symbol}:`, {
                            currentPrice: meta.regularMarketPrice || meta.previousClose,
                            exchange: meta.exchangeName,
                            currency: meta.currency,
                            marketState: meta.marketState
                        });
                        
                        // Get current/latest price
                        const currentPrice = meta.regularMarketPrice || meta.previousClose;
                        const marketTime = new Date(meta.regularMarketTime * 1000);
                        
                        // Process historical data with dates
                        const historicalData = [];
                        const closePrices = prices.close;
                        
                        if (timestamps && closePrices && timestamps.length > 0) {
                            const startIndex = Math.max(0, Math.min(timestamps.length, closePrices.length) - 60);
                            
                            for (let i = startIndex; i < Math.min(timestamps.length, closePrices.length); i++) {
                                if (closePrices[i] !== null && !isNaN(closePrices[i]) && timestamps[i]) {
                                    const date = new Date(timestamps[i] * 1000);
                                    historicalData.push({
                                        date: date,
                                        price: closePrices[i],
                                        dateString: date.toISOString().split('T')[0],
                                        dayName: date.toLocaleDateString('en-US', { weekday: 'short' })
                                    });
                                }
                            }
                        }
                        
                        // Check data quality
                        if (historicalData.length < 10) {
                            throw new Error(`Insufficient historical data for ${symbol} (${historicalData.length} points)`);
                        }
                        
                        console.log(`‚úÖ ${symbol} data quality check passed:`, {
                            dataPoints: historicalData.length,
                            dateRange: {
                                start: historicalData[0]?.dateString,
                                end: historicalData[historicalData.length - 1]?.dateString
                            }
                        });
                        
                        return {
                            currentPrice: currentPrice,
                            historicalData: historicalData,
                            historicalPrices: historicalData.map(d => d.price),
                            marketState: meta.marketState,
                            marketTime: marketTime,
                            lastUpdate: new Date(),
                            currency: meta.currency,
                            exchange: meta.exchangeName,
                            symbol: symbol, // Return the successful symbol
                            dataPoints: historicalData.length,
                            timezone: meta.exchangeTimezoneName,
                            tradingPeriod: meta.currentTradingPeriod,
                            dateRange: {
                                start: historicalData.length > 0 ? historicalData[0].dateString : null,
                                end: historicalData.length > 0 ? historicalData[historicalData.length - 1].dateString : null
                            }
                        };
                        
                    } else {
                        throw new Error(`Invalid response format for ${symbol}`);
                    }
                    
                } catch (error) {
                    console.warn(`‚ùå Failed to fetch data for ${symbol}:`, error.message);
                    lastError = error;
                    continue; // Try next symbol
                }
            }
            
            // If all symbols failed, fall back to enhanced demo data
            console.error('‚ùå All symbols failed. Last error:', lastError);
            const enhancedDemoData = generateEnhancedDemoDataWithDates(commodity);
            showError(`Could not fetch live data for any symbol. Using enhanced demo data. Last error: ${lastError.message}`);
            
            return {
                currentPrice: enhancedDemoData.currentPrice,
                historicalData: enhancedDemoData.historicalData,
                historicalPrices: enhancedDemoData.historicalPrices,
                marketState: 'DEMO',
                marketTime: new Date(),
                lastUpdate: new Date(),
                currency: config.currency,
                exchange: config.exchange,
                symbol: config.yahoo_symbol,
                dataPoints: enhancedDemoData.historicalData.length,
                timezone: 'Demo/Local',
                dateRange: enhancedDemoData.dateRange,
                isDemo: true
            };
        }

        // Generate enhanced demo data with realistic dates
        function generateEnhancedDemoDataWithDates(commodity) {
            const config = commodities[commodity];
            const baseData = config.samplePrices;
            
            // Create 60 days of data going backwards from today
            const historicalData = [];
            const today = new Date();
            
            for (let i = 59; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                // Skip weekends for financial data
                if (date.getDay() === 0 || date.getDay() === 6) {
                    continue;
                }
                
                const priceIndex = Math.min(i, baseData.length - 1);
                let price = baseData[priceIndex];
                
                // Add some realistic variation
                const variation = (Math.random() - 0.5) * price * 0.02; // ¬±1% random
                price += variation;
                
                historicalData.push({
                    date: new Date(date),
                    price: Math.max(price * 0.8, price),
                    dateString: date.toISOString().split('T')[0],
                    dayName: date.toLocaleDateString('en-US', { weekday: 'short' })
                });
            }
            
            const currentPrice = historicalData[historicalData.length - 1].price;
            
            return {
                currentPrice: currentPrice,
                historicalData: historicalData,
                historicalPrices: historicalData.map(d => d.price),
                dateRange: {
                    start: historicalData[0].dateString,
                    end: historicalData[historicalData.length - 1].dateString
                }
            };
        }

        function calculateVolatility(prices) {
            if (prices.length < 2) return 0;
            
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push((prices[i] - prices[i-1]) / prices[i-1]);
            }
            
            const avgReturn = returns.reduce((sum, r) => sum + r, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length;
            
            return Math.sqrt(variance) * prices[prices.length - 1];
        }
        let currentCommodity = 'oil';
        let priceChart;
        let arimaForecast = null;
        let sentimentAnalysis = null;
        let currentData = null;
        let isAnalyzing = false;

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateCommodityInfo();
            loadDemoData();
        });

        function setupEventListeners() {
            // Commodity selection
            document.querySelectorAll('.commodity-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (isAnalyzing) return;
                    
                    document.querySelectorAll('.commodity-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentCommodity = this.dataset.commodity;
                    updateCommodityInfo();
                    clearAllResults();
                    loadDemoData();
                });
            });

            // Slider updates
            document.getElementById('sentimentWeight').addEventListener('input', function() {
                document.getElementById('weightDisplay').textContent = (this.value * 100) + '%';
            });

            document.getElementById('confidenceThreshold').addEventListener('input', function() {
                document.getElementById('confidenceDisplay').textContent = (this.value * 100) + '%';
            });
        }

        function updateCommodityInfo() {
            const commodity = commodities[currentCommodity];
            
            // Update result labels
            document.getElementById('resultsCommodity').textContent = commodity.name.split(' ')[0];
            document.getElementById('resultsUnit').textContent = commodity.unit;
            document.getElementById('currencySymbol').textContent = commodity.currency;
            document.getElementById('currencySymbol2').textContent = commodity.currency;
        }

        function loadDemoData() {
            const commodity = commodities[currentCommodity];
            
            showLoading("Loading enhanced demo data for " + commodity.name + "...");
            
            setTimeout(() => {
                const enhancedData = generateEnhancedDemoDataWithDates(currentCommodity);
                
                currentData = {
                    prices: enhancedData.historicalPrices,
                    historical_data: enhancedData.historicalData,
                    sentiment_texts: commodity.sampleSentiment,
                    latest_price: enhancedData.currentPrice,
                    data_source: 'enhanced_demo',
                    market_state: 'DEMO',
                    last_update: new Date(),
                    data_points: enhancedData.historicalData.length,
                    date_range: enhancedData.dateRange
                };
                
                updateMarketDataDisplay();
                hideLoading();
            }, 1000);
        }

        async function fetchRealTimeData() {
            const commodity = currentCommodity;
            const config = commodities[commodity];
            
            try {
                showLoading(`Fetching real-time data for ${config.name}...`);
                
                // Fetch current price and historical data with dates
                const priceData = await fetchCurrentPrice(commodity);
                
                console.log('Received price data:', priceData);
                
                // If we got real data, use it; otherwise use enhanced demo
                if (priceData.historicalData && priceData.historicalData.length >= 30) {
                    currentData = {
                        prices: priceData.historicalPrices,
                        historical_data: priceData.historicalData, // Full data with dates
                        sentiment_texts: commodity.sampleSentiment, // Still using demo sentiment for now
                        latest_price: priceData.currentPrice,
                        data_source: priceData.isDemo ? 'enhanced_demo' : 'live_yahoo',
                        market_state: priceData.marketState,
                        market_time: priceData.marketTime,
                        last_update: priceData.lastUpdate,
                        data_points: priceData.dataPoints,
                        exchange: priceData.exchange,
                        currency: priceData.currency,
                        timezone: priceData.timezone,
                        date_range: priceData.dateRange
                    };
                    
                    updateMarketDataDisplay();
                    displayDataQualityInfo(priceData);
                    
                    if (!priceData.isDemo) {
                        showSuccess(`‚úÖ Successfully fetched live data: ${priceData.dataPoints} price points from ${priceData.exchange}`);
                        console.log('Date range:', priceData.dateRange);
                        console.log('First 5 data points with dates:', priceData.historicalData.slice(0, 5));
                        console.log('Last 5 data points with dates:', priceData.historicalData.slice(-5));
                    } else {
                        showSuccess(`üìä Using enhanced demo data with realistic dates: ${priceData.dataPoints} points`);
                    }
                } else {
                    throw new Error('Insufficient historical data points');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Failed to fetch real-time data:', error);
                
                // Fallback to enhanced demo data with dates
                const enhancedData = generateEnhancedDemoDataWithDates(commodity);
                currentData = {
                    prices: enhancedData.historicalPrices,
                    historical_data: enhancedData.historicalData,
                    sentiment_texts: config.sampleSentiment,
                    latest_price: enhancedData.currentPrice,
                    data_source: 'enhanced_demo_fallback',
                    market_state: 'DEMO',
                    last_update: new Date(),
                    data_points: enhancedData.historicalData.length,
                    date_range: enhancedData.dateRange
                };
                
                updateMarketDataDisplay();
                showError(`Real-time data fetch failed: ${error.message}. Using enhanced demo data.`);
                hideLoading();
            }
        }

        function displayDataQualityInfo(priceData) {
            // Add a detailed data quality section that can be expanded
            const qualityDiv = document.createElement('div');
            qualityDiv.id = 'dataQualityInfo';
            qualityDiv.innerHTML = `
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleDataDetails()">
                        <h5 style="color: #2c3e50; margin: 0;">üìä Data Quality Details</h5>
                        <span id="toggleIcon">‚ñº</span>
                    </div>
                    <div id="dataDetails" style="display: none; margin-top: 15px; font-size: 0.85rem; color: #6c757d;">
                        <p><strong>Symbol:</strong> ${priceData.symbol}</p>
                        <p><strong>Data Points:</strong> ${priceData.dataPoints}</p>
                        <p><strong>Date Range:</strong> ${priceData.dateRange.start} to ${priceData.dateRange.end}</p>
                        <p><strong>Market State:</strong> ${priceData.marketState}</p>
                        <p><strong>Current Price:</strong> ${priceData.currency}${priceData.currentPrice.toFixed(2)}</p>
                        <p><strong>Market Time:</strong> ${priceData.marketTime ? priceData.marketTime.toLocaleString() : 'N/A'}</p>
                        <p><strong>Exchange:</strong> ${priceData.exchange}</p>
                        <p><strong>Timezone:</strong> ${priceData.timezone}</p>
                        ${!priceData.isDemo ? `
                        <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px;">
                            <strong>‚úÖ Live Data Confirmed</strong><br>
                            <small>Fetched directly from Yahoo Finance API</small>
                        </div>
                        ` : `
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                            <strong>üìä Demo Data</strong><br>
                            <small>Using realistic demo data with proper date simulation</small>
                        </div>
                        `}
                        <div style="margin-top: 15px;">
                            <strong>Sample Data Points:</strong>
                            <div style="font-family: monospace; font-size: 0.8rem; background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                                ${priceData.historicalData ? priceData.historicalData.slice(-5).map(d => 
                                    `${d.dateString} (${d.dayName}): ${d.price.toFixed(2)}`
                                ).join('<br>') : 'No detailed data available'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing quality info if present
            const existing = document.getElementById('dataQualityInfo');
            if (existing) {
                existing.remove();
            }
            
            // Add to market data section
            const marketDataDiv = document.getElementById('marketData');
            marketDataDiv.appendChild(qualityDiv);
        }

        function toggleDataDetails() {
            const details = document.getElementById('dataDetails');
            const icon = document.getElementById('toggleIcon');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function updateMarketDataDisplay() {
            if (!currentData) return;
            
            const commodity = commodities[currentCommodity];
            const marketDataDiv = document.getElementById('marketData');
            
            // Determine market status display
            let marketStatusColor = '#6c757d';
            let marketStatusText = 'Demo Mode';
            
            if (currentData.data_source === 'live_yahoo') {
                marketStatusColor = '#28a745';
                marketStatusText = `Live (${currentData.market_state})`;
            } else if (currentData.data_source === 'enhanced_demo') {
                marketStatusColor = '#ffc107';
                marketStatusText = 'Enhanced Demo';
            }
            
            // Calculate price change from previous day
            let priceChange = 0;
            let priceChangePercent = 0;
            if (currentData.prices && currentData.prices.length >= 2) {
                const prevPrice = currentData.prices[currentData.prices.length - 2];
                priceChange = currentData.latest_price - prevPrice;
                priceChangePercent = (priceChange / prevPrice) * 100;
            }
            
            const changeColor = priceChange >= 0 ? '#28a745' : '#dc3545';
            const changeSymbol = priceChange >= 0 ? '+' : '';
            
            // Date range display
            let dateRangeText = 'N/A';
            if (currentData.date_range) {
                dateRangeText = `${currentData.date_range.start} to ${currentData.date_range.end}`;
            }
            
            marketDataDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 2.2rem; font-weight: bold; color: #667eea;">
                        ${commodity.currency}${currentData.latest_price.toFixed(2)}
                    </div>
                    <div style="color: ${changeColor}; font-size: 1.1rem; font-weight: 600; margin: 5px 0;">
                        ${changeSymbol}${priceChange.toFixed(2)} (${changeSymbol}${priceChangePercent.toFixed(2)}%)
                    </div>
                    <div style="color: #6c757d;">Current Price</div>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d;">
                    <p><strong>Data Points:</strong> ${currentData.data_points || currentData.prices.length}</p>
                    <p><strong>Date Range:</strong> ${dateRangeText}</p>
                    <p><strong>Market Status:</strong> <span style="color: ${marketStatusColor}; font-weight: 600;">${marketStatusText}</span></p>
                    <p><strong>Last Update:</strong> ${currentData.last_update ? currentData.last_update.toLocaleTimeString() : 'N/A'}</p>
                    <p><strong>Exchange:</strong> ${currentData.exchange || commodity.exchange}</p>
                    <p><strong>Timezone:</strong> ${currentData.timezone || 'N/A'}</p>
                    <p><strong>Data Quality:</strong> ${currentData.data_points >= 50 ? '‚úÖ Excellent' : currentData.data_points >= 30 ? '‚ö†Ô∏è Good' : '‚ùå Limited'}</p>
                </div>
                ${currentData.data_source === 'live_yahoo' ? `
                <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                    <div style="font-size: 0.85rem; color: #155724;">
                        <strong>‚úÖ Live Data Verified</strong><br>
                        Symbol: ${currentData.symbol}<br>
                        Market Time: ${currentData.market_time ? currentData.market_time.toLocaleString() : 'N/A'}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function updateDataSourcesDisplay() {
            const commodity = commodities[currentCommodity];
            const dataSourcesDiv = document.getElementById('dataSources');
            
            dataSourcesDiv.innerHTML = `
                <div style="font-size: 0.9rem; color: #6c757d;">
                    <p><strong>Yahoo Finance:</strong> ${commodity.yahoo_symbol}</p>
                    <p><strong>Reddit Terms:</strong> ${commodity.reddit_terms.slice(0, 3).join(', ')}${commodity.reddit_terms.length > 3 ? '...' : ''}</p>
                    <p><strong>Subreddits:</strong> ${commodity.subreddits.slice(0, 3).join(', ')}${commodity.subreddits.length > 3 ? '...' : ''}</p>
                    <p><strong>Key Factors:</strong> ${commodity.factors.split(',')[0]}...</p>
                </div>
            `;
        }

        // ARIMA Implementation (Enhanced)
        class EnhancedARIMA {
            constructor(data, p = 2, d = 1, q = 1) {
                this.data = data;
                this.p = p;
                this.d = d;
                this.q = q;
                this.coefficients = [];
                this.rmse = 0;
            }

            difference(data, order = 1) {
                let diffData = [...data];
                for (let i = 0; i < order; i++) {
                    const newDiff = [];
                    for (let j = 1; j < diffData.length; j++) {
                        newDiff.push(diffData[j] - diffData[j - 1]);
                    }
                    diffData = newDiff;
                }
                return diffData;
            }

            autoRegression(data, order) {
                const coefficients = [];
                const n = data.length;
                
                for (let lag = 1; lag <= order; lag++) {
                    let sumXY = 0, sumX = 0, sumY = 0, sumX2 = 0, sumY2 = 0;
                    const validPoints = n - lag;
                    
                    for (let i = lag; i < n; i++) {
                        sumXY += data[i] * data[i - lag];
                        sumX += data[i - lag];
                        sumY += data[i];
                        sumX2 += data[i - lag] * data[i - lag];
                        sumY2 += data[i] * data[i];
                    }
                    
                    // Calculate correlation coefficient
                    const numerator = validPoints * sumXY - sumX * sumY;
                    const denominator = Math.sqrt((validPoints * sumX2 - sumX * sumX) * (validPoints * sumY2 - sumY * sumY));
                    const correlation = denominator !== 0 ? numerator / denominator : 0;
                    
                    coefficients.push(Math.max(-0.9, Math.min(0.9, correlation))); // Limit coefficients
                }
                
                return coefficients;
            }

            forecast(steps = 1) {
                try {
                    if (this.data.length < Math.max(5, this.p + this.d)) {
                        throw new Error('Insufficient data points');
                    }

                    const diffData = this.difference(this.data, this.d);
                    this.coefficients = this.autoRegression(diffData, this.p);
                    
                    let forecast = [];
                    let lastValues = [...diffData.slice(-this.p)];
                    
                    // Generate forecasts
                    for (let step = 0; step < steps; step++) {
                        let nextValue = 0;
                        
                        // AR component
                        for (let i = 0; i < Math.min(this.p, lastValues.length); i++) {
                            nextValue += this.coefficients[i] * lastValues[lastValues.length - 1 - i];
                        }
                        
                        // Add some noise reduction
                        nextValue *= 0.95; // Damping factor
                        
                        forecast.push(nextValue);
                        lastValues.push(nextValue);
                        if (lastValues.length > this.p) {
                            lastValues.shift();
                        }
                    }
                    
                    // Convert back from differenced data
                    const actualForecast = [];
                    let lastActual = this.data[this.data.length - 1];
                    
                    for (let i = 0; i < forecast.length; i++) {
                        lastActual += forecast[i];
                        actualForecast.push(Math.max(0, lastActual)); // Ensure positive prices
                    }
                    
                    this.rmse = this.calculateRMSE(diffData, this.coefficients);
                    
                    return {
                        forecast: actualForecast,
                        coefficients: this.coefficients,
                        rmse: this.rmse
                    };
                    
                } catch (error) {
                    console.error('ARIMA forecast error:', error);
                    
                    // Enhanced fallback: trend + seasonality
                    const recentData = this.data.slice(-Math.min(10, this.data.length));
                    const trend = recentData.length > 1 ? 
                        (recentData[recentData.length - 1] - recentData[0]) / (recentData.length - 1) : 0;
                    
                    const forecast = [];
                    const basePrice = this.data[this.data.length - 1];
                    
                    for (let i = 0; i < steps; i++) {
                        // Add some randomness and damping
                        const randomFactor = (Math.random() - 0.5) * 0.02; // ¬±1% random variation
                        const dampingFactor = Math.pow(0.98, i); // Reduce trend over time
                        const forecastPrice = basePrice + (trend * (i + 1) * dampingFactor) + (basePrice * randomFactor);
                        forecast.push(Math.max(basePrice * 0.8, forecastPrice)); // Don't go below 80% of current price
                    }
                    
                    return { 
                        forecast, 
                        coefficients: [trend], 
                        rmse: Math.abs(trend) * 0.1 
                    };
                }
            }

            calculateRMSE(data, coefficients) {
                let sumSquaredErrors = 0;
                let count = 0;
                
                for (let i = this.p; i < data.length; i++) {
                    let predicted = 0;
                    for (let j = 0; j < Math.min(this.p, coefficients.length); j++) {
                        if (i - 1 - j >= 0) {
                            predicted += coefficients[j] * data[i - 1 - j];
                        }
                    }
                    
                    const error = data[i] - predicted;
                    sumSquaredErrors += error * error;
                    count++;
                }
                
                return count > 0 ? Math.sqrt(sumSquaredErrors / count) : 0;
            }
        }

        // Enhanced Hybrid Sentiment Analysis
        function calculateHybridSentiment(text) {
            const commodity = commodities[currentCommodity];
            
            // Method 1: Domain-specific lexicon analysis
            const lexiconResult = calculateLexiconSentiment(text, commodity);
            
            // Method 2: Contextual analysis with negation handling
            const contextualResult = calculateContextualSentiment(text);
            
            // Combine both methods with weighting
            const lexiconWeight = 0.6;
            const contextualWeight = 0.4;
            
            const hybridPolarity = (lexiconResult.polarity * lexiconWeight) + 
                                 (contextualResult.polarity * contextualWeight);
            
            const hybridConfidence = Math.max(lexiconResult.confidence, contextualResult.confidence);
            
            return {
                polarity: Math.max(-1, Math.min(1, hybridPolarity)),
                confidence: hybridConfidence,
                lexiconScore: lexiconResult.polarity,
                contextualScore: contextualResult.polarity,
                scoredWords: lexiconResult.scoredWords,
                totalWords: lexiconResult.totalWords,
                method: 'hybrid'
            };
        }

        function calculateLexiconSentiment(text, commodity) {
            const words = text.toLowerCase().replace(/[^\w\s]/g, ' ').split(/\s+/);
            let totalScore = 0;
            let scoredWords = 0;

            const sentimentLexicon = { ...globalSentimentTerms, ...commodity.sentimentTerms };

            words.forEach(word => {
                if (sentimentLexicon[word] !== undefined) {
                    totalScore += sentimentLexicon[word];
                    scoredWords++;
                }
            });

            const polarity = scoredWords > 0 ? totalScore / scoredWords : 0;
            const confidence = Math.min(1, scoredWords / Math.max(5, words.length * 0.3));

            return {
                polarity: Math.max(-1, Math.min(1, polarity)),
                confidence,
                scoredWords,
                totalWords: words.length
            };
        }

        function calculateContextualSentiment(text) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            let totalPolarity = 0;
            let processedSentences = 0;

            sentences.forEach(sentence => {
                const sentencePolarity = analyzeSentenceContext(sentence.trim());
                if (sentencePolarity !== null) {
                    totalPolarity += sentencePolarity;
                    processedSentences++;
                }
            });

            const avgPolarity = processedSentences > 0 ? totalPolarity / processedSentences : 0;
            const confidence = Math.min(1, processedSentences / Math.max(1, sentences.length));

            return {
                polarity: Math.max(-1, Math.min(1, avgPolarity)),
                confidence
            };
        }

        function analyzeSentenceContext(sentence) {
            const words = sentence.toLowerCase().replace(/[^\w\s]/g, ' ').split(/\s+/);
            if (words.length === 0) return null;

            let sentenceScore = 0;
            let wordCount = 0;
            let negation = false;
            
            const negationWords = ['not', 'no', 'never', 'none', 'neither', 'nothing', 'nowhere', 
                                 'cannot', 'cant', 'couldnt', 'shouldnt', 'wouldnt', 'dont', 'doesnt', 'didnt'];
            
            const intensifiers = {
                'very': 1.5, 'extremely': 2.0, 'highly': 1.7, 'significantly': 1.8,
                'substantially': 1.6, 'dramatically': 1.9, 'considerably': 1.5,
                'remarkably': 1.7, 'exceptionally': 1.8, 'particularly': 1.3,
                'quite': 1.2, 'rather': 1.1, 'really': 1.4, 'truly': 1.6
            };

            let currentIntensifier = 1.0;

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                
                if (negationWords.includes(word)) {
                    negation = true;
                    continue;
                }
                
                if (intensifiers[word]) {
                    currentIntensifier = intensifiers[word];
                    continue;
                }
                
                const commodity = commodities[currentCommodity];
                const sentimentLexicon = { ...globalSentimentTerms, ...commodity.sentimentTerms };
                
                if (sentimentLexicon[word] !== undefined) {
                    let score = sentimentLexicon[word] * currentIntensifier;
                    
                    if (negation) {
                        score = -score;
                        negation = false;
                    }
                    
                    sentenceScore += score;
                    wordCount++;
                    currentIntensifier = 1.0;
                }
            }

            return wordCount > 0 ? sentenceScore / wordCount : null;
        }

        // Main Analysis Functions
        function runCompleteAnalysis() {
            if (isAnalyzing) return;
            
            if (!currentData) {
                showError("No data available. Please load data first.");
                return;
            }
            
            isAnalyzing = true;
            showLoading("Running complete analysis...");
            
            setTimeout(() => {
                try {
                    // Run ARIMA forecast
                    runARIMAAnalysis();
                    
                    // Run sentiment analysis
                    runSentimentAnalysis();
                    
                    // Combine results
                    if (arimaForecast && sentimentAnalysis) {
                        calculateFinalPrediction();
                        generateTradingSignal();
                        updateChart();
                        updateDataSourcesDisplay();
                        document.getElementById('results').classList.remove('hidden');
                    }
                    
                    hideLoading();
                    showSuccess("Complete analysis finished successfully!");
                } catch (error) {
                    console.error('Analysis error:', error);
                    showError("Analysis failed: " + error.message);
                    hideLoading();
                } finally {
                    isAnalyzing = false;
                }
            }, 2000);
        }

        function runARIMAAnalysis() {
            if (!currentData || !currentData.prices) {
                throw new Error("No price data available");
            }

            const forecastDays = parseInt(document.getElementById('forecastDays').value);
            const modelType = document.getElementById('arimaModel').value;
            
            let p = 2, d = 1, q = 1;
            if (modelType === 'simple') {
                p = 1; d = 1; q = 1;
            } else if (modelType === 'complex') {
                p = 3; d = 1; q = 2;
            }

            const arima = new EnhancedARIMA(currentData.prices, p, d, q);
            arimaForecast = arima.forecast(forecastDays);

            displayARIMAResults(arimaForecast);
        }

        function runSentimentAnalysis() {
            if (!currentData || !currentData.sentiment_texts) {
                throw new Error("No sentiment data available");
            }

            const analyses = currentData.sentiment_texts.map(text => ({
                text: text.trim(),
                ...calculateHybridSentiment(text.trim())
            }));

            const avgPolarity = analyses.reduce((sum, a) => sum + a.polarity, 0) / analyses.length;
            const avgConfidence = analyses.reduce((sum, a) => sum + a.confidence, 0) / analyses.length;
            const avgLexiconScore = analyses.reduce((sum, a) => sum + (a.lexiconScore || 0), 0) / analyses.length;
            const avgContextualScore = analyses.reduce((sum, a) => sum + (a.contextualScore || 0), 0) / analyses.length;

            sentimentAnalysis = {
                avgPolarity,
                avgConfidence,
                avgLexiconScore,
                avgContextualScore,
                analyses,
                totalTexts: analyses.length
            };

            displaySentimentResults(sentimentAnalysis);
        }

        function calculateFinalPrediction() {
            if (!arimaForecast || !sentimentAnalysis) return;

            const sentimentWeight = parseFloat(document.getElementById('sentimentWeight').value);
            const volatilityLevel = document.getElementById('volatilityLevel').value;
            const confidenceThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
            
            const arimaPrice = arimaForecast.forecast[0];
            const sentimentScore = sentimentAnalysis.avgPolarity;
            const sentimentConfidence = sentimentAnalysis.avgConfidence;
            
            // Volatility multiplier
            const volatilityMultiplier = {
                'low': 0.5,
                'medium': 1.0,
                'high': 1.5
            }[volatilityLevel];
            
            // Confidence adjustment
            const confidenceAdjustment = sentimentConfidence >= confidenceThreshold ? 1.0 : 0.7;
            
            // Calculate final prediction
            const sentimentAdjustment = sentimentScore * sentimentWeight * volatilityMultiplier * confidenceAdjustment;
            const finalPrice = arimaPrice * (1 + sentimentAdjustment);
            
            const priceChange = ((finalPrice - currentData.latest_price) / currentData.latest_price) * 100;
            const overallConfidence = Math.min(95, 
                (arimaForecast.rmse > 0 ? 60 : 70) + 
                (sentimentAnalysis.avgConfidence * 25) + 
                (currentData.prices.length > 20 ? 10 : 0)
            );

            // Update prediction display
            const commodity = commodities[currentCommodity];
            document.getElementById('finalPrice').textContent = finalPrice.toFixed(2);
            document.getElementById('arimaPrice').textContent = arimaPrice.toFixed(2);
            document.getElementById('sentimentScore').textContent = sentimentScore.toFixed(3);
            document.getElementById('confidence').textContent = overallConfidence.toFixed(1);
            document.getElementById('priceChange').textContent = priceChange.toFixed(2);
            document.getElementById('currentPrice').textContent = currentData.latest_price.toFixed(2);
            document.getElementById('dataPoints').textContent = currentData.prices.length;
            
            // Store for trading signal generation
            window.predictionResults = {
                finalPrice,
                arimaPrice,
                sentimentScore,
                priceChange,
                confidence: overallConfidence,
                currentPrice: currentData.latest_price
            };
        }

        function generateTradingSignal() {
            if (!window.predictionResults) return;

            const { priceChange, sentimentScore, confidence } = window.predictionResults;
            const confidenceThreshold = parseFloat(document.getElementById('confidenceThreshold').value) * 100;
            
            let signal = 'HOLD';
            let reason = 'Insufficient confidence for clear signal';
            let signalClass = 'signal-hold';
            
            if (confidence >= confidenceThreshold) {
                if (priceChange > 2 && sentimentScore > 0.1) {
                    signal = 'STRONG BUY';
                    reason = `High confidence bullish signal: +${priceChange.toFixed(1)}% predicted with positive sentiment`;
                    signalClass = 'signal-buy';
                } else if (priceChange > 0.5 && sentimentScore > 0) {
                    signal = 'BUY';
                    reason = `Moderate bullish signal: +${priceChange.toFixed(1)}% predicted with positive sentiment`;
                    signalClass = 'signal-buy';
                } else if (priceChange < -2 && sentimentScore < -0.1) {
                    signal = 'STRONG SELL';
                    reason = `High confidence bearish signal: ${priceChange.toFixed(1)}% predicted with negative sentiment`;
                    signalClass = 'signal-sell';
                } else if (priceChange < -0.5 && sentimentScore < 0) {
                    signal = 'SELL';
                    reason = `Moderate bearish signal: ${priceChange.toFixed(1)}% predicted with negative sentiment`;
                    signalClass = 'signal-sell';
                } else {
                    signal = 'HOLD';
                    reason = `Mixed signals or neutral outlook: ${priceChange.toFixed(1)}% predicted change`;
                }
            }
            
            document.getElementById('signalText').textContent = signal;
            document.getElementById('signalReason').textContent = reason;
            document.getElementById('tradeSignal').className = `trade-signal ${signalClass}`;
        }

        function displayARIMAResults(forecast) {
            const commodity = commodities[currentCommodity];
            const resultsDiv = document.getElementById('arimaResults');
            const nextPrice = forecast.forecast[0];
            const rmse = forecast.rmse;
            const modelType = document.getElementById('arimaModel').value;
            
            resultsDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #667eea;">
                        ${commodity.currency}${nextPrice.toFixed(2)}
                    </div>
                    <div style="color: #6c757d;">Next Period Forecast</div>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d;">
                    <p><strong>Model:</strong> ARIMA (${modelType})</p>
                    <p><strong>Training Data:</strong> ${currentData.prices.length} points</p>
                    <p><strong>RMSE:</strong> ${rmse.toFixed(4)}</p>
                    <p><strong>Coefficients:</strong> [${forecast.coefficients.map(c => c.toFixed(3)).join(', ')}]</p>
                    <p><strong>Forecast Horizon:</strong> ${document.getElementById('forecastDays').value} days</p>
                </div>
            `;
        }

        function displaySentimentResults(sentiment) {
            const resultsDiv = document.getElementById('sentimentResults');
            const avgPolarity = sentiment.avgPolarity;
            const label = avgPolarity > 0.1 ? 'Bullish' : avgPolarity < -0.1 ? 'Bearish' : 'Neutral';
            const className = avgPolarity > 0.1 ? 'positive' : avgPolarity < -0.1 ? 'negative' : 'neutral';
            
            resultsDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="padding: 8px 16px; border-radius: 20px; font-size: 1.1rem; display: inline-block; color: white; background: ${
                        avgPolarity > 0.1 ? '#28a745' : avgPolarity < -0.1 ? '#dc3545' : '#17a2b8'
                    };">
                        ${label} (Hybrid AI)
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">${avgPolarity.toFixed(3)}</div>
                    <div style="color: #6c757d;">Combined Polarity Score</div>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 15px;">
                    <p><strong>Texts Analyzed:</strong> ${sentiment.totalTexts}</p>
                    <p><strong>Avg Confidence:</strong> ${(sentiment.avgConfidence * 100).toFixed(1)}%</p>
                    <p><strong>Market Sentiment:</strong> ${label}</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h5 style="color: #2c3e50; margin-bottom: 10px;">AI Method Breakdown:</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Domain Lexicon (60%):</strong><br>
                            <span style="font-size: 1.2rem; color: #667eea;">${sentiment.avgLexiconScore.toFixed(3)}</span>
                            <div style="font-size: 0.8rem; color: #6c757d;">Commodity expertise</div>
                        </div>
                        <div>
                            <strong>Contextual AI (40%):</strong><br>
                            <span style="font-size: 1.2rem; color: #764ba2;">${sentiment.avgContextualScore.toFixed(3)}</span>
                            <div style="font-size: 0.8rem; color: #6c757d;">Grammar & context</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateChart() {
            if (!currentData || !arimaForecast) return;

            const commodity = commodities[currentCommodity];
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            const historical = currentData.prices;
            const forecast = arimaForecast.forecast;
            const forecastDays = parseInt(document.getElementById('forecastDays').value);

            const labels = [];
            for (let i = 0; i < historical.length; i++) {
                labels.push(`Day ${i + 1}`);
            }
            for (let i = 0; i < forecastDays; i++) {
                labels.push(`Forecast ${i + 1}`);
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Historical Prices',
                        data: historical,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.1,
                        pointRadius: 2
                    }, {
                        label: 'ARIMA Forecast',
                        data: Array(historical.length).fill(null).concat(forecast.slice(0, forecastDays)),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        pointRadius: 4,
                        pointStyle: 'triangle'
                    }, {
                        label: 'Sentiment Adjusted',
                        data: Array(historical.length).fill(null).concat([window.predictionResults?.finalPrice]),
                        borderColor: '#ff6b6b',
                        backgroundColor: '#ff6b6b',
                        pointRadius: 8,
                        pointStyle: 'star',
                        showLine: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: `${commodity.name} Price (${commodity.unit})`
                            },
                            grid: {
                                alpha: 0.3
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period'
                            },
                            grid: {
                                alpha: 0.3
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${commodity.name} - AI-Enhanced Price Prediction`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${commodity.currency}${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // API and Data Functions
        function testApiConnection() {
            showLoading("Testing API connections...");
            
            setTimeout(() => {
                const redditId = document.getElementById('redditClientId').value;
                const redditSecret = document.getElementById('redditClientSecret').value;
                
                document.getElementById('apiStatus').classList.remove('hidden');
                
                if (redditId && redditSecret) {
                    document.getElementById('redditStatus').textContent = "Configured (Demo)";
                    document.getElementById('redditStatus').style.color = "#28a745";
                } else {
                    document.getElementById('redditStatus').textContent = "Not Configured";
                    document.getElementById('redditStatus').style.color = "#dc3545";
                }
                
                document.getElementById('yahooStatus').textContent = "Ready";
                document.getElementById('yahooStatus').style.color = "#28a745";
                
                hideLoading();
                showSuccess("API connection test completed!");
            }, 1500);
        }

        function fetchLiveData() {
            // This function is replaced by fetchRealTimeData() but kept for compatibility
            fetchRealTimeData();
        }

        function runForecastOnly() {
            if (isAnalyzing) return;
            
            if (!currentData) {
                showError("No data available. Please load data first.");
                return;
            }
            
            isAnalyzing = true;
            showLoading("Running ARIMA forecast...");
            
            setTimeout(() => {
                try {
                    runARIMAAnalysis();
                    updateChart();
                    document.getElementById('results').classList.remove('hidden');
                    hideLoading();
                    showSuccess("ARIMA forecast completed!");
                } catch (error) {
                    showError("Forecast failed: " + error.message);
                    hideLoading();
                } finally {
                    isAnalyzing = false;
                }
            }, 1500);
        }

        function runSentimentOnly() {
            if (isAnalyzing) return;
            
            if (!currentData) {
                showError("No data available. Please load data first.");
                return;
            }
            
            isAnalyzing = true;
            showLoading("Running sentiment analysis...");
            
            setTimeout(() => {
                try {
                    runSentimentAnalysis();
                    updateDataSourcesDisplay();
                    document.getElementById('results').classList.remove('hidden');
                    hideLoading();
                    showSuccess("Sentiment analysis completed!");
                } catch (error) {
                    showError("Sentiment analysis failed: " + error.message);
                    hideLoading();
                } finally {
                    isAnalyzing = false;
                }
            }, 1500);
        }

        function clearAllResults() {
            document.getElementById('results').classList.add('hidden');
            arimaForecast = null;
            sentimentAnalysis = null;
            window.predictionResults = null;
            
            if (priceChart) {
                priceChart.destroy();
                priceChart = null;
            }
            
            showSuccess("Results cleared!");
        }

        // UI Helper Functions
        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingDisplay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingDisplay').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.main-content').firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.main-content').firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        function toggleApiConfig() {
            const apiConfig = document.querySelector('.api-config');
            const button = event.target;
            
            if (apiConfig.style.display === 'none') {
                apiConfig.style.display = 'block';
                button.textContent = 'Hide Configuration';
            } else {
                apiConfig.style.display = 'none';
                button.textContent = 'Show Configuration';
            }
        }

        // Initialize demo data on load
        window.addEventListener('load', function() {
            setTimeout(() => {
                showSuccess("Welcome to the Ultimate Commodity Prediction System! Demo data loaded and ready for analysis.");
            }, 1000);
        });
    </script>
</body>
</html>